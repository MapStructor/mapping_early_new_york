<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Draw a polygon and calculate its area</title>
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
    <link href="https://api.mapbox.com/mapbox-gl-js/v3.0.1/mapbox-gl.css" rel="stylesheet" />
    <script src="https://api.mapbox.com/mapbox-gl-js/v3.0.1/mapbox-gl.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
        }
        #map {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 100%;
        }
        .calculation-box {
            height: auto;
            min-height: 200px;
            width: 200px;
            position: absolute;
            top: 10px;
            left: 10px;
            background-color: rgba(255, 255, 255, 0.9);
            padding: 15px;
            text-align: center;
            overflow: auto;
        }
        p,
        input,
        button,
        select {
            font-family: "Open Sans";
            margin: 0;
            font-size: 13px;
            width: 100%;
            margin-bottom: 10px;
        }
        input[id="file_upload"] {
            height: 0px;
            opacity: 0;
            width: 100%;
        }
    </style>
</head>
<body>
    <div id="map"></div>
    
    <div class="calculation-box">
      <input type="text" id="title-input" placeholder="Title" />
      <textarea id="info-input" placeholder="Additional information"></textarea>
      <input type="number" id="nid-input" placeholder="NID" />
      <input type="number" id="daystart-input" placeholder="DayStart" />
      <input type="number" id="dayend-input" placeholder="Day End" />
      <input type="number" id="daystart2-input" placeholder="Day Start 2" />
      <input type="text" id="change-input" placeholder="Change" />
      <textarea id="changetext-input" placeholder="Change Text" >2</textarea>
      <button onclick="updateFeatureInfo()">Save</button>
      <button><label for="file_upload">Upload GeoJSON</label></button>
      <div id="calculated-area"></div>
      <button onclick="downloadGeoJSON()">Download GeoJSON</button>
      <input type="file" id="file_upload" accept=".geojson" onchange="handleFileUpload()" />
      <select id="geojson-selector" onchange="loadSelectedGeoJSON()">
          <option value="">Select a GeoJSON</option>
          <option value="example.geojson">example.geojson</option>
          <option value="drawn_polygon2.geojson">drawn_polygon2.geojson</option>
          <option value="info_of_interest.geojson">info_of_interest.geojson</option>
      </select>
      <select id="feature-id-dropdown">
          <option value="">Select a Feature ID</option>
      </select>
    </div>

    <script src="https://unpkg.com/@turf/turf@6/turf.min.js"></script>
    <script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-draw/v1.4.3/mapbox-gl-draw.js"></script>
    <link rel="stylesheet" href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-draw/v1.4.3/mapbox-gl-draw.css" type="text/css" />
    <script>
        mapboxgl.accessToken = "pk.eyJ1IjoibWFwbnkiLCJhIjoiY2xtMG93amk4MnBrZTNnczUzY2VvYjg0ciJ9.MDMHYBlVbG14TJD120t6NQ";
        const map = new mapboxgl.Map({
            container: "map",
            style: "mapbox://styles/mapbox/satellite-v9",
            center: [-73.935242, 40.730610],
            zoom: 10,
        });

        const draw = new MapboxDraw({
            displayControlsDefault: false,
            controls: {
                point: true,
                line_string: true,
                polygon: true,
                trash: true,
            },
            defaultMode: "draw_polygon",
        });

        map.addControl(draw);

        function loadSelectedGeoJSON() {
            const selector = document.getElementById('geojson-selector');
            const selectedFile = selector.value;
            if (selectedFile) {
                loadGeoJSON(selectedFile);
            }
        }


        // Add the event listener to the feature ID dropdown
        document.getElementById('feature-id-dropdown').addEventListener('change', function() {
            const selectedFeatureId = this.value;
            if (selectedFeatureId) {
                const selectedFeature = localGeoJSON.features.find(feature => feature.id === selectedFeatureId);
                if (selectedFeature) {
                    // Update the input fields with the selected feature's properties
                    document.getElementById("title-input").value = selectedFeature.properties.Label || "";
                    document.getElementById("info-input").value = selectedFeature.properties.changetext || "";
                    document.getElementById("nid-input").value = selectedFeature.properties.nid || 0;
                    document.getElementById("daystart-input").value = selectedFeature.properties.DayStart || 0;
                    document.getElementById("dayend-input").value = selectedFeature.properties.DayEnd || 0;
                    document.getElementById("daystart2-input").value = selectedFeature.properties.DayStart2 || 0;
                    document.getElementById("change-input").value = selectedFeature.properties.change || "";
                    document.getElementById("changetext-input").value = selectedFeature.properties.changetext || "";
                }
            }
        });

        function loadGeoJSON(filename) {
            const signedUrls = {
                "info_of_interest.geojson": "https://storage.googleapis.com/meny_geojsons_bucket/info_of_interest.geojson?x-goog-signature=1530e8239a867ca65a75b15dd0409f9c5e9f20b8909ca6b5b08b5a5c914a1edfe959e1f5295f32cbfe7822401f0ed39e32c864f7849b2cde9af115a9c53f31c731dcb74133d2f782cfeb6d09bcebb81867f242f75dcf806f0a7b6a9d31d0a54f74714af76307868daa874c4928d9c2e5ca5b0a1060d9ea63b6e0aec444e322674be820911c3a40939142ea4a3d8fd5fa0e7f416dcd84eb9889e216dc6c90cac656ddcb2ea230e40d8983cc46d417b9722cac7fc4131c9dd938b859993a52b2476c54991d2bcd862c7503a4f48afd360336899e9c5362e351c3335dbab1214d241271fc316feb3bf0e9985206a56a2b1de2c275c604a1ed0ddc1910aa91999df0&x-goog-algorithm=GOOG4-RSA-SHA256&x-goog-credential=meny-geojsons-service-account%40meny-geojsons.iam.gserviceaccount.com%2F20240330%2Fus%2Fstorage%2Fgoog4_request&x-goog-date=20240330T065939Z&x-goog-expires=604800&x-goog-signedheaders=host"
            }
            const url = signedUrls[filename];
            fetch(url)
            .then(response => {
                return response.json()
            })
            .then(data => {
                draw.set(data);
                localGeoJSON = data;
            })
            .catch(error => console.error('Error loading GeoJSON:', error));
        }

        map.on("draw.create", updateArea);
        map.on("draw.delete", updateArea);
        map.on("draw.update", updateArea);
        map.on("draw.selectionchange", onSelectFeature);

        function updateArea(e) {
            if (e.type === "draw.create" || e.type === "draw.delete") {
                localGeoJSON = draw.getAll();
            }
        }

        function onSelectFeature(e) {
            if (e.features.length > 0) {
                const feature = e.features[0];
                document.getElementById("title-input").value = feature.properties.Label || "";
                document.getElementById("info-input").value = feature.properties.changetext || "";
                document.getElementById("nid-input").value = feature.properties.nid || 0;
                document.getElementById("daystart-input").value = feature.properties.DayStart || 0;
                document.getElementById("dayend-input").value = feature.properties.DayEnd || 0;
                document.getElementById("daystart2-input").value = feature.properties.DayStart2 || 0;
                document.getElementById("change-input").value = feature.properties.change || "";
            }
        }

        function updateFeatureInfo() {
            console.log("Updating feature info")
            const title = document.getElementById("title-input").value;
            const info = document.getElementById("info-input").value;
            const nid = Number(document.getElementById("nid-input").value);
            const dayStart = Number(document.getElementById("daystart-input").value);
            const dayEnd = Number(document.getElementById("dayend-input").value);
            const dayStart2 = Number(document.getElementById("daystart2-input").value);
            const change = document.getElementById("change-input").value;
            const changeText = document.getElementById("changetext-input").value;

            const selectedFeatures = draw.getSelected();

            if (selectedFeatures.features.length > 0) {
                console.log("Inside if statement of updating feature info")
                const feature = selectedFeatures.features[0];
                feature.properties.Label = title;
                feature.properties.changetext = info;
                feature.properties.nid = nid;
                feature.properties.DayStart = dayStart;
                feature.properties.DayEnd = dayEnd;
                feature.properties.DayStart2 = dayStart2;
                feature.properties.change = change;
                feature.properties.changetext = changeText;

                // Update the local GeoJSON copy
                const featureIndex = localGeoJSON.features.findIndex((f) => f.id === feature.id);
                if (featureIndex !== -1) {
                    localGeoJSON.features[featureIndex].properties = feature.properties;
                }

                // Upload the updated GeoJSON to Google Cloud Storage
                const url = `https://storage.googleapis.com/meny_geojsons_bucket/${document.getElementById('geojson-selector').value}`;
                fetch(url, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(localGeoJSON)
                })
                .then(response => {
                    if (response.ok) {
                        console.log('Success:', response);
                        loadSelectedGeoJSON();
                    } else {
                        console.error('Upload failed:', response);
                    }
                })
                .catch(error => console.error('Error:', error));
            } else {
                alert("No feature selected. Select a feature to update its information.");
            }
        }




        function downloadGeoJSON() {
            const data = localGeoJSON;
            if (data.features.length > 0) {
                const geojson = JSON.stringify(data);
                const blob = new Blob([geojson], { type: "application/json" });
                const url = URL.createObjectURL(blob);
                const a = document.createElement("a");
                a.style.display = "none";
                a.href = url;
                a.download = "drawn_polygon.geojson";
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
            } else {
                alert("No polygon to download. Draw a polygon first.");
            }
        }

        function handleFileUpload() {
            const fileInput = document.getElementById("file_upload");
            const file = fileInput.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    draw.add(JSON.parse(e.target.result));
                    draw.changeMode("simple_select");
                };
                reader.readAsText(file);
            }
        }

        map.on('load', function () {
            loadSelectedGeoJSON();

            // Add a click event listener for the features
            map.on('click', function(e) {
                const features = map.queryRenderedFeatures(e.point);
                if (features.length > 0) {
                    populateFeatureIdDropdown(features);
                }
            });
        });

        function populateFeatureIdDropdown(features) {
            const dropdown = document.getElementById('feature-id-dropdown');
            dropdown.innerHTML = '<option value="">Select a Feature ID</option>'; // Clear existing options
            features.forEach(feature => {
                const option = document.createElement('option');
                option.value = feature.properties.id; // Access id from properties
                option.textContent = feature.properties.id; // Access id from properties
                dropdown.appendChild(option);
            });
        }


    </script>
  </body>
</html>
