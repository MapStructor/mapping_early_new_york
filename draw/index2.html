<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Draw a polygon and calculate its area</title>
    <meta
      name="viewport"
      content="initial-scale=1,maximum-scale=1,user-scalable=no"
    />
    <link
      href="https://api.mapbox.com/mapbox-gl-js/v3.0.1/mapbox-gl.css"
      rel="stylesheet"
    />
    <script src="https://api.mapbox.com/mapbox-gl-js/v3.0.1/mapbox-gl.js"></script>
    <style>
      body {
        margin: 0;
        padding: 0;
      }
      #map {
        position: absolute;
        top: 0;
        bottom: 0;
        width: 100%;
      }
      .calculation-box {
        height: 200px;
        width: 200px;
        position: absolute;
        top: 10px;
        left: 10px;
        background-color: rgba(255, 255, 255, 0.9);
        padding: 15px;
        text-align: center;
      }
      p,
      input,
      button {
        font-family: "Open Sans";
        margin: 0;
        font-size: 13px;
        width: 100%;
        margin-bottom: 10px;
      }
      input[id="file_upload"] {
        height: 0px;
        opacity: 0;
        width: 100%;
      }
    </style>
  </head>
  <body>
    <div id="map"></div>


    <div class="calculation-box">
      <input type="text" id="title-input" placeholder="Title" />
      <textarea id="info-input" placeholder="Additional information"></textarea>
      <!-- <textarea id="description-input" placeholder="Description"></textarea> -->
      <button onclick="updateFeatureInfo()">Save</button>
      <button><label for="file_upload">Upload GeoJSON</label></button>
      <div id="calculated-area"></div>
      <button onclick="downloadGeoJSON()">Download GeoJSON</button>
      <input
        type="file"
        id="file_upload"
        accept=".geojson"
        onchange="handleFileUpload()"
      />
    </div>
    


    <script src="https://unpkg.com/@turf/turf@6/turf.min.js"></script>
    <script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-draw/v1.4.3/mapbox-gl-draw.js"></script>
    <link
      rel="stylesheet"
      href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-draw/v1.4.3/mapbox-gl-draw.css"
      type="text/css"
    />
    <script>
      mapboxgl.accessToken =
        "pk.eyJ1IjoibWFwbnkiLCJhIjoiY2xtMG93amk4MnBrZTNnczUzY2VvYjg0ciJ9.MDMHYBlVbG14TJD120t6NQ";
      const map = new mapboxgl.Map({
        container: "map", // container ID
        style: "mapbox://styles/mapbox/satellite-v9", // style URL
        center: [-91.874, 42.76], // starting position [lng, lat]
        zoom: 12, // starting zoom
      });

      const draw = new MapboxDraw({
        displayControlsDefault: false,
        controls: {
          point: true,
          line_string: true,
          polygon: true,
          trash: true,
        },
        defaultMode: "draw_polygon",
      });

      map.addControl(draw);

      function loadGeoJSON() {
    const url = 'https://storage.googleapis.com/meny_geojsons_bucket/example.geojson';
    const cacheBuster = new Date().getTime(); // Current timestamp

    fetch(`${url}?nocache=${cacheBuster}`)
    .then(response => response.json())
    .then(data => {
        draw.set(data);
        localGeoJSON = data; // Update the local GeoJSON variable
    })
    .catch(error => console.error('Error loading GeoJSON:', error));
}





      map.on("draw.create", updateArea);
      map.on("draw.delete", updateArea);
      map.on("draw.update", updateArea);
      map.on("draw.selectionchange", onSelectFeature);

      function updateArea(e) {
        // Your existing area calculation logic

        // Update the local GeoJSON copy
        if (e.type === "draw.create" || e.type === "draw.delete") {
          localGeoJSON = draw.getAll();
        }
      }

      function onSelectFeature(e) {
      if (e.features.length > 0) {
        const feature = e.features[0];
        document.getElementById("title-input").value = feature.properties.title || "";
        document.getElementById("info-input").value = feature.properties.info || "";
      }
    }




    function updateFeatureInfo() {
    const title = document.getElementById("title-input").value;
    const info = document.getElementById("info-input").value;
    const selectedFeatures = draw.getSelected();

    if (selectedFeatures.features.length > 0) {
        const feature = selectedFeatures.features[0];
        feature.properties.title = title;
        feature.properties.info = info;

        // Update the local GeoJSON copy
        const featureIndex = localGeoJSON.features.findIndex(
            (f) => f.id === feature.id
        );
        if (featureIndex !== -1) {
            localGeoJSON.features[featureIndex] = feature;
        } else {
            localGeoJSON.features.push(feature);
        }

        // Upload the updated GeoJSON to Google Cloud Storage
        const url = 'https://storage.googleapis.com/meny_geojsons_bucket/info_of_interest.geojson';
        fetch(url, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(localGeoJSON)
        })
        .then(response => {
            if (response.ok) {
                console.log('Success:', response);
                // Reload the GeoJSON from the storage
                loadGeoJSON();
            } else {
                console.error('Upload failed:', response);
            }
        })
        .catch((error) => {
            console.error('Error:', error);
        });
    } else {
        alert("No feature selected. Select a feature to update its information.");
    }
}





      function downloadGeoJSON() {
        const data = draw.getAll();
        if (data.features.length > 0) {
          const geojson = JSON.stringify(data);
          const blob = new Blob([geojson], { type: "application/json" });
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.style.display = "none";
          a.href = url;
          a.download = "drawn_polygon.geojson";
          document.body.appendChild(a);
          a.click();
          window.URL.revokeObjectURL(url);
        } else {
          alert("No polygon to download. Draw a polygon first.");
        }
      }

      function handleFileUpload() {
        const fileInput = document.getElementById("file_upload");
        const file = fileInput.files[0];

        if (file) {
          const reader = new FileReader();

          reader.onload = function (e) {
            const contents = e.target.result;
            draw.add(JSON.parse(contents));
            draw.changeMode("simple_select");
          };

          reader.readAsText(file);
        }
      }




      function initialLoadGeoJSON() {
        loadGeoJSON();
        }


      map.on('load', function () {
    // Uncomment the line below to enable initial loading of GeoJSON
    // initialLoadGeoJSON();

    // Add a click event listener for the features
    map.on('click', function(e) {
        // Query rendered features at the clicked point
        // from the 'gl-draw-point' layer.
        const features = map.queryRenderedFeatures(e.point, { layers: ['gl-draw-point'] });

        if (features.length > 0) {
            const feature = features[0];

            // If a feature is clicked, select it in the MapboxDraw control
            draw.changeMode('simple_select', { featureIds: [feature.id] });

            // Update the input fields with the feature's properties
            document.getElementById("title-input").value = feature.properties.title || "";
            document.getElementById("info-input").value = feature.properties.info || "";
        }
    });
});





    </script>
  </body>
</html>
